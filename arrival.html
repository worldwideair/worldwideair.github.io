<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>여정 도착 - Worldwide Air</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,800;1,800&family=Poppins:ital,wght@0,400;0,500;0,600;0,800;1,800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f4f4f4;
      position: relative;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .logo {
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      font-style: italic;
      font-size: 1.5rem;
      color: #003366;
      text-decoration: none;
    }

    .back-button {
      padding: 0.5rem 1rem;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .back-button:hover {
      background-color: #ccc;
      color: black;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #003366;
      margin-bottom: 1rem;
    }

    .ticket {
      display: flex;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      background-color: white;
    }

    .ticket-summary {
      background-color: #003366;
      color: #fff;
      padding: 1.5rem;
      width: 30%;
      font-size: 1.25rem;
      font-family: 'Poppins', sans-serif;
      font-weight: 400;
      line-height: 1.5;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: left;
      border-right: 5px dashed #fff;
    }

    .ticket-content {
      background-color: white;
      padding: 1.5rem;
      width: 60%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }

    .article-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .article-text {
      font-size: 0.9rem;
      color: #444;
      line-height: 1.5;
      max-height: 7em;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      margin-bottom: 1.5rem;
    }

    .source-url {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 0.3rem;
    }

    .article-link {
      font-size: 0.9rem;
      color: #003366;
      text-decoration: none;
      align-self: flex-end;
    }

    .article-link:hover {
      text-decoration: underline;
    }

    .center-message {
      text-align: center;
      margin-top: 4rem;
      font-size: 1.2rem;
      color: #777;
    }

    @media (max-width: 768px) {
      .ticket {
        flex-direction: column;
      }
      .ticket-summary, .ticket-content {
        width: 100%;
        border-right: none;
      }
    }

    #idle-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      color: #333;
      font-size: 1rem;
      padding: 1.2rem 1.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      z-index: 1000;
    }
    #initial-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #initial-popup-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 90vw;
      text-align: center;
      font-size: 1rem;
      line-height: 1.6;
    }

    #initial-popup-content button {
      margin-top: 1.5rem;
      padding: 0.6rem 1.2rem;
      background: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="initial-popup">
    <div id="initial-popup-content">
      <p><strong>안내사항</strong><br>
      "기사 보기" 버튼으로 원문을 여행하신 후,<br>
      다음 분들이 여정에 참여하실 수 있도록 꼭 <strong>원문 탭을 닫아주세요.</strong></p>
      <button onclick="closeInitialPopup()">확인</button>
    </div>
  </div>

  <p style="display: none;">
    This paragraph exists solely to help your web browser recognize the original language of this page as English. 
    If you are using a browser like Safari or Chrome that supports automatic translation, this content may help trigger a translation suggestion banner when the page loads. 
    This technique is especially useful in cases where the visible content of the page is minimal, dynamically generated, or primarily written in another language such as Korean or Japanese. 
    By including this clearly written, well-formed English text in the source code, we ensure that language detection algorithms can accurately identify the document's primary language. 
    This, in turn, allows the browser to offer translation options to users whose browser interface is set to a different language.
    Even though this text is completely hidden from your view and does not interfere with the visible layout or user experience, it plays a subtle yet important role in improving accessibility and multilingual support.
    We are committed to creating a more inclusive browsing experience, and small technical details like this can significantly impact the usability of a website across different languages and regions.
    Thank you for your understanding and support as we continue to optimize this project for a wider, global audience.
  </p>
  <div id="top-bar">
    <a class="logo" href="index.html" translate="no">Worldwide Air</a>
    <button class="back-button" onclick="history.back()">뒤로</button>
  </div>

  <div class="section-title">도착지의 장면들</div>

  <div id="article-results"></div>

  <div id="idle-popup">10초 동안 활동이 없으면 여정 탐색이 종료됩니다.</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const selectedCountry = params.get("country");
    const selectedWeek = params.get("week");
    const selectedEvent = params.get("event");

    const apiKey = "AIzaSyAwT4PTt4fce8qxpyUedKsTKyCAaHtIzfU";
    const sheetId = "1ZBsOtyhmiwka1SC0yYSiSLX3-bi0b-sQHu24GuCRhzA";

    let sheetName = "";
    try {
      const [year, month, week] = selectedWeek.split("-");
      sheetName = `flight_${year.slice(2)}${month}w${week.slice(1)}`;
    } catch {
      document.getElementById("article-results").innerHTML = "<p class='center-message'>주차 정보가 올바르지 않습니다.</p>";
      throw new Error("Invalid week format");
    }

    const endpoint = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;

    fetch(endpoint)
      .then(res => {
        if (!res.ok) throw new Error(`Google Sheets API 오류: ${res.status}`);
        return res.json();
      })
      .then(data => {
        const rows = data.values;
        if (!rows || !Array.isArray(rows) || rows.length < 2) {
          throw new Error("Sheet is empty or invalid data");
        }

        const headers = rows[0];
        const body = rows.slice(1);
        const col = name => headers.indexOf(name);

        const filtered = body.filter(row =>
          row[col("Countrycode")] === selectedCountry &&
          row[col("GLOBALEVENTID")] === selectedEvent
        );

        const container = document.getElementById("article-results");

        if (filtered.length === 0) {
          container.innerHTML = "<p class='center-message'>기사를 찾을 수 없습니다.</p>";
          return;
        }

        filtered.forEach(row => {
          const title = row[col("ArticleTitle")];
          const summary = row[col("Summary")];
          const text = row[col("ArticleText")];
          const url = row[col("MentionIdentifier")];
          const source = row[col("MentionSourceName")];

          const ticket = document.createElement("div");
          ticket.className = "ticket";
          ticket.innerHTML = `
            <div class="ticket-summary">${summary}</div>
            <div class="ticket-content">
              <div>
                <div class="article-title">${title}</div>
                <div class="article-text">${text}</div>
              </div>
              <div>
                <div class="source-url">${source}</div>
                <a class="article-link" href="${url}" target="_blank">기사 보기</a>
              </div>
            </div>
          `;
          container.appendChild(ticket);
        });
      })
      .catch(err => {
        console.error("데이터 불러오기 실패:", err);
        document.getElementById("article-results").innerHTML = "<p class='center-message'>기사를 불러오는 데 실패했습니다.</p>";
      });

    // ⏱️ 비활성 감지 타이머
    let idleTimer, popupTimer, redirectTimer;
    const popup = document.getElementById("idle-popup");

    function resetTimers() {
      clearTimeout(idleTimer);
      clearTimeout(popupTimer);
      clearTimeout(redirectTimer);
      popup.style.display = "none";
      idleTimer = setTimeout(() => {
        popup.style.display = "block";
        popupTimer = setTimeout(() => {
          popup.style.display = "none";
          redirectTimer = setTimeout(() => {
            window.location.href = "index.html";
          }, 1000);
        }, 9000);
      }, 30000);
    }

    function closeInitialPopup() {
      const popup = document.getElementById('initial-popup');
      popup.style.display = 'none';
    }

    setTimeout(() => {
      closeInitialPopup();
    }, 10000); // 10초 후 자동 닫힘

    ["mousemove", "mousedown", "keydown", "touchstart"].forEach(evt =>
      document.addEventListener(evt, resetTimers)
    );
    resetTimers();
  </script>
</body>
</html>
