<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì—¬ì • ì„ íƒ - Worldwide Air</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,800;1,800&family=Poppins:ital,wght@0,400;0,500;0,600;0,800;1,800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f4f4f4;
      position: relative;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .logo {
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      font-style: italic;
      font-size: 1.5rem;
      color: #003366;
      cursor: pointer;
      text-decoration: none;
    }
    form#journey-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    select {
      border-radius: 6px;
      border: 1px solid #ccc;
      height: 35px;
      width: 100px;
    }
    .search-button {
      height: 35px;
      padding: 0 1rem;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .search-button:hover {
      background-color: #ccc;
    }
    .section-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #003366;
      margin-bottom: 1rem;
    }
    .flight-block {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .flight-block:hover {
      background-color: #f9f9f9;
    }
    .flight-title {
      font-size: 0.95rem;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
    }
    .flight-meta {
      font-size: 0.9rem;
      color: #555;
      margin-left: 1rem;
      white-space: nowrap;
    }
    .center-message {
      text-align: center;
      margin-top: 4rem;
      font-size: 1.2rem;
      color: #777;
    }

    /* ğŸ”¸ ì•Œë¦¼ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    #idle-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      color: #333;
      font-size: 1rem;
      padding: 1.2rem 1.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <a class="logo" href="index.html" translate="no">Worldwide Air</a>

    <form id="journey-form">
      <select id="departure-country">
        <option value="KOR">í•œêµ­</option>
        <option value="USA">ë¯¸êµ­</option>
        <option value="JPN">ì¼ë³¸</option>
        <option value="IRN">ì´ë€</option>
        <option value="ISR">ì´ìŠ¤ë¼ì—˜</option>
        <option value="UKR">ìš°í¬ë¼ì´ë‚˜</option>
        <option value="RUS">ëŸ¬ì‹œì•„</option>
        <option value="IND">ì¸ë„</option>
        <option value="FRA">í”„ë‘ìŠ¤</option>
        <option value="THA">íƒœêµ­</option>
        <option value="ZAF">ë‚¨ì•„ê³µ</option>
        <option value="AUS">í˜¸ì£¼</option>
        <option value="EGY">ì´ì§‘íŠ¸</option>
        <option value="MEX">ë©•ì‹œì½”</option>
        <option value="BRA">ë¸Œë¼ì§ˆ</option>
      </select>

      <select id="week">
        <option value="2025-06-W1">6ì›” 1ì£¼ì°¨</option>
        <option value="2025-06-W2">6ì›” 2ì£¼ì°¨</option>
        <option value="2025-06-W3">6ì›” 3ì£¼ì°¨</option>
        <option value="2025-06-W4">6ì›” 4ì£¼ì°¨</option>
        <option value="2025-07-W1">7ì›” 1ì£¼ì°¨</option>
        <option value="2025-07-W2">7ì›” 2ì£¼ì°¨</option>
        <option value="2025-07-W3">7ì›” 3ì£¼ì°¨</option>
        <option value="2025-07-W4">7ì›” 4ì£¼ì°¨</option>
        <option value="2025-08-W1">8ì›” 1ì£¼ì°¨</option>
        <option value="2025-08-W2">8ì›” 2ì£¼ì°¨</option>
      </select>

      <button class="search-button" type="submit">ì—¬ì • ê²€ìƒ‰</button>
    </form>
  </div>

  <div id="flight-section"></div>

  <div id="idle-popup">10ì´ˆ ë™ì•ˆ í™œë™ì´ ì—†ìœ¼ë©´ ì—¬ì • íƒìƒ‰ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const selectedCountry = urlParams.get("country");
    const selectedWeek = urlParams.get("week");

    if (selectedCountry) document.getElementById("departure-country").value = selectedCountry;
    if (selectedWeek) document.getElementById("week").value = selectedWeek;

    const apiKey = "AIzaSyAwT4PTt4fce8qxpyUedKsTKyCAaHtIzfU";
    const sheetId = "1ZBsOtyhmiwka1SC0yYSiSLX3-bi0b-sQHu24GuCRhzA";

    let sheetName = "";
    try {
      const [year, month, week] = selectedWeek.split("-");
      sheetName = `flight_${year.slice(2)}${month}w${week.slice(1)}`;
    } catch {
      document.getElementById("flight-section").innerHTML = `<div class="center-message">ì£¼ì°¨ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
      throw new Error("Invalid week format");
    }

    const endpoint = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;

    fetch(endpoint)
      .then(res => res.json())
      .then(data => {
        const rows = data.values;
        if (!rows || rows.length < 2) throw new Error("ë°ì´í„° ì—†ìŒ");
        const headers = rows[0];
        const body = rows.slice(1);
        const col = name => headers.indexOf(name);
        const byEvent = {};
        body.forEach(row => {
          if (row[col("Countrycode")] !== selectedCountry) return;
          const id = row[col("GLOBALEVENTID")];
          const rank = parseInt(row[col("event_rank")]) || 9999;
          const summary = row[col("GLOBALEVENTID_summary")];
          if (!byEvent[id] && summary?.trim()) {
            byEvent[id] = { summary, minEventRank: rank, count: 1 };
          } else if (byEvent[id]) {
            byEvent[id].count++;
            if (rank < byEvent[id].minEventRank) byEvent[id].minEventRank = rank;
          }
        });
        const section = document.getElementById("flight-section");
        section.innerHTML = "";
        const events = Object.entries(byEvent).sort(([, a], [, b]) => a.minEventRank - b.minEventRank);
        if (!events.length) {
          section.innerHTML = `<div class="center-message">í•­ê³µí¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }
        const title = document.createElement("div");
        title.className = "section-title";
        title.textContent = "í•­ê³µí¸ ì„ íƒ";
        section.appendChild(title);
        events.forEach(([eventId, data]) => {
          const block = document.createElement("div");
          block.className = "flight-block";
          block.onclick = () =>
            location.href = `arrival.html?event=${eventId}&country=${selectedCountry}&week=${selectedWeek}`;
          block.innerHTML = `<div class="flight-title">${data.summary}</div><div class="flight-meta">ê²€ìƒ‰ ìˆ˜: ${data.count}ê±´</div>`;
          section.appendChild(block);
        });
      })
      .catch(() => {
        document.getElementById("flight-section").innerHTML = `<div class="center-message">í•­ê³µí¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
      });

    document.getElementById("journey-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const country = document.getElementById("departure-country").value;
      const week = document.getElementById("week").value;
      window.location.href = `boarding.html?country=${country}&week=${week}`;
    });

    // â±ï¸ ë¹„í™œì„± ê°ì§€ íƒ€ì´ë¨¸
    let idleTimer, popupTimer, redirectTimer;
    const popup = document.getElementById("idle-popup");

    function resetTimers() {
      clearTimeout(idleTimer);
      clearTimeout(popupTimer);
      clearTimeout(redirectTimer);
      popup.style.display = "none";
      idleTimer = setTimeout(() => {
        popup.style.display = "block";
        popupTimer = setTimeout(() => {
          popup.style.display = "none";
          redirectTimer = setTimeout(() => {
            window.location.href = "index.html";
          }, 1000);
        }, 9000);
      }, 30000);
    }

    ["mousemove", "mousedown", "keydown", "touchstart"].forEach(evt =>
      document.addEventListener(evt, resetTimers)
    );
    resetTimers();
  </script>
</body>
</html>
